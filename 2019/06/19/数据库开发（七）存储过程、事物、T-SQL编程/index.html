<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="zhendong在github上的个人博客">
    <meta name="keyword" content="">
    <meta name="theme-color" content="#600090">
    <meta name="msapplication-navbutton-color" content="#600090">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="#600090">
    <link rel="shortcut icon" href="/images/favicon.ico">
    <link rel="alternate" type="application/atom+xml" title="Zhendong" href="/atom.xml">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.css">
    <title>
        
        数据库开发（七）存储过程、事物、T-SQL编程｜Zhendong&#39;s blog
        
    </title>

    <link rel="canonical" href="https://zhdaa.github.io/2019/06/19/数据库开发（七）存储过程、事物、T-SQL编程/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/blog-style.css">

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">
</head>

<style>

    header.intro-header {
        background-image: url('/images/zhdaa-headimg.jpg')
    }
</style>
<!-- hack iOS CSS :active style -->
<body ontouchstart="" class="animated fadeIn">
<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top " id="nav-top" data-ispost = "true" data-istags="false
" data-ishome = "false" >
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand animated pulse" href="/">
                <span class="brand-logo">
                    Zhendong
                </span>
                's Blog
            </a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <!-- /.navbar-collapse -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>
					
                    
                        
							
                        <li>
                            <a href="/Tags/">Tags</a>
                        </li>
							
						
                    
					
					
                </ul>
            </div>
        </div>
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
//    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>

<!-- Main Content -->

<!--only post-->


<img class="wechat-title-img"
     src="/images/post-ocean.jpg">


<style>
    
    header.intro-header {
        background-image: url('/images/post-ocean.jpg')
    }

    
</style>

<header class="intro-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <div class="post-heading">
                    <h1>数据库开发（七）存储过程、事物、T-SQL编程</h1>
                    
                    <span class="meta">
                         作者 Zhendong Ho
                        <span>
                          日期 2019-06-19
                         </span>
                    </span>
                    <div class="tags text-center">
                        
                        <a class="tag" href="/tags/#SQL Server"
                           title="SQL Server">SQL Server</a>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="post-title-haojen">
        <span>
            数据库开发（七）存储过程、事物、T-SQL编程
        </span>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <!-- Post Container -->
            <div class="col-lg-8 col-lg-offset-1 col-sm-9 post-container">
                <h2 id="外连接"><a href="#外连接" class="headerlink" title="外连接"></a>外连接</h2><h3 id="左外连接和右外连接"><a href="#左外连接和右外连接" class="headerlink" title="左外连接和右外连接"></a>左外连接和右外连接</h3><p>当需要把一张表的数据都显示出来的时候，需要用到外连接（左外连接或右外连接）。</p>
<p>左外连接：<strong>left join 或 left outer join</strong>。</p>
<p>右外连接：<strong>right join 或 right outer join。</strong></p>
<p>左表：出现在left join左边的表就叫做左表。</p>
<p>右表：出现在left join右边的表就叫做右表。</p>
<p>查询出<strong>所有参加了考试的同学</strong>的姓名，年龄，英语成绩，数学成绩<strong>（使用内连接）</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    t1.tsname,</span><br><span class="line">    t1.tsage,</span><br><span class="line">    t2.tEnglish,</span><br><span class="line">    t2.tMath</span><br><span class="line">from TblStudent as t1</span><br><span class="line">inner join TblScore as t2 on t1.tsid=t2.tsid</span><br></pre></td></tr></table></figure>
<p>查询出<strong>所有同学</strong>的姓名，年龄，英语成绩，数学成绩<strong>（使用左外连接）</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    t1.tsid,</span><br><span class="line">    t1.tsname,</span><br><span class="line">    t1.tsage,</span><br><span class="line">    t2.tEnglish,</span><br><span class="line">    t2.tMath</span><br><span class="line">from TblStudent as t1</span><br><span class="line">left join TblScore as t2 on t1.tsid=t2.tsid</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>内连接，只显示那些两张表中可以匹配的数据。</li>
<li>左外连接，会将所有左表中的数据全部显示。同时，对于左表中的数据，如果在右表中能找到匹配的数据，那么显示对应右表中的数据；如果在右表中找不到对应的匹配，则显示null。</li>
</ul>
<p>查询出那些<strong>所有没有参加考试的同学</strong>的学生ID，姓名和年龄。</p>
<p>第一种，通过<strong>子查询</strong>实现。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from TblStudent where tsid not in (select tsid from TblStudent)</span><br></pre></td></tr></table></figure>
<p>第二种，通过<strong>左外连接</strong>查询实现。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    t1.*,</span><br><span class="line">    t2.*</span><br><span class="line">from TblStudent as t1</span><br><span class="line">left join TblScore as t2 on t1.tsid=t2.tsid</span><br><span class="line">where t2.tscoreId is null</span><br></pre></td></tr></table></figure>
<p>第三种，通过<strong>右外连接</strong>查询实现。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--右外连接，显示右表的所有记录（方法和左外连接一样，只是调换左表和右表的位置）</span><br><span class="line">select</span><br><span class="line">    t1.*,</span><br><span class="line">    t2.*</span><br><span class="line">from TblScore as t2</span><br><span class="line">right join TblStudent as t1 on t1.tsid=t2.tsid</span><br><span class="line">where t2.tscoreId is null</span><br><span class="line"></span><br><span class="line">--右外连接，显示右表的所有记录（不调换左表和右表的位置）</span><br><span class="line">select</span><br><span class="line">    t1.*,</span><br><span class="line">    t2.*</span><br><span class="line">from TblStudent as t1</span><br><span class="line">right join TblScore as t2 on t1.tsid=t2.tsid</span><br></pre></td></tr></table></figure>
<h3 id="外连接的原理"><a href="#外连接的原理" class="headerlink" title="外连接的原理"></a>外连接的原理</h3><p>当使用连接查询的时候。如果同时要指定查询的条件，那么<strong>一定要使用where语句，不要直接在on条件后面跟and来编写其他查询条件。</strong></p>
<p>下面这种写法是有问题的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    t1.*,</span><br><span class="line">    t2.*</span><br><span class="line">from TblStudent as t1</span><br><span class="line">left join TblScore as t2 on t1.tsid=t2.tsid -- and t1.tsgender = &apos;男&apos; --on条件后面跟and可能会有问题，left join会查询出TblStudent表中所有数据</span><br><span class="line">where t1.tsgener = &apos;男&apos; --筛选条件要放到where子句中</span><br></pre></td></tr></table></figure>
<p>下面这种写法可以正常显示要查询的数据。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    t1.*,</span><br><span class="line">    t2.*</span><br><span class="line">from TblStudent as t1</span><br><span class="line">inner join TblScore as t2 on t1.tsid=t2.tsid and t1.tsgender = &apos;男&apos; --正常显示要查询的数据。因为inner join不需要增加外部列，而外连接是对笛卡儿积筛选完之后，再增加外部列</span><br></pre></td></tr></table></figure>
<p>外连接的执行过程：</p>
<ol>
<li>第一步，构建笛卡儿积。</li>
<li>根据left join on条件，从中进行数据筛选。</li>
<li>因为是外连接，所以要显示左表中的所有记录。所以接下来就要进行“添加外部行”（把TblStudent表中的没有筛选出来的那些数据，再添加到当前的查询结果集中）。</li>
</ol>
<h2 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h2><p>一张表自己和自己连接起来查询数据。使用自连接时必须给表起列名。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select</span><br><span class="line">    t1.AreaId 城市编号</span><br><span class="line">    t2.AreaName 城市名称</span><br><span class="line">    t3.AreaName 省份名称</span><br><span class="line">from TblArea as t1</span><br><span class="line">inner join TblArea as t2 on t1.AreaId=t2.AreaPid</span><br></pre></td></tr></table></figure>
<h2 id="多条件查询"><a href="#多条件查询" class="headerlink" title="多条件查询"></a>多条件查询</h2><p>当用户需要输入多条件模糊查询时，要根据用户输入的内容动态拼接SQL语句。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button1_Click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//假设表名：Books</span></span><br><span class="line">    <span class="comment">//列名：BookName（书名）、Author（作者）、Pub（出版社）</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//多条件查询，要根据用户输入的内容来动态拼接SQL语句。</span></span><br><span class="line">    <span class="comment">//1.假设用户没有输入任何条件，那么就查询出所有的记录</span></span><br><span class="line">    StringBuilder sbSql = <span class="keyword">new</span> StringBuilder(<span class="string">"select * from Books"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//在wheres集合中保存查询的sql条件</span></span><br><span class="line">    List&lt;<span class="keyword">string</span>&gt; wheres = <span class="keyword">new</span> List&lt;<span class="keyword">string</span>&gt;();</span><br><span class="line">    <span class="comment">//把参数也放到一个集合当中</span></span><br><span class="line">    List&lt;SqlParameter&gt; listParameters = <span class="keyword">new</span> List&lt;SqlParameter&gt;();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//2.如果用户输入了条件，则根据用户输入的条件动态拼接SQL语句</span></span><br><span class="line">    <span class="keyword">if</span> (txtBookName.Text.Trim().Length &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        wheres.Add(<span class="string">" BookName like @bkName "</span>);</span><br><span class="line">        listParameters.Add(<span class="keyword">new</span> SqlParameter(<span class="string">"@bkName"</span>, SqlDbType.NVarChar, <span class="number">100</span>) &#123; Value = <span class="string">"%"</span> + txtBookName.Text.Trim() + <span class="string">"%"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (txtAuthor.Text.Trim().Length &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        wheres.Add(<span class="string">" Author like @author "</span>);</span><br><span class="line">        listParameters.Add(<span class="keyword">new</span> SqlParameter(<span class="string">"@author"</span>, SqlDbType.NVarChar, <span class="number">100</span>) &#123; Value = <span class="string">"%"</span> + txtAuthor.Text.Trim() + <span class="string">"%"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (txtPub.Text.Trim().Length &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        wheres.Add(<span class="string">" Pub like @pub "</span>);</span><br><span class="line">        listParameter.Add(<span class="keyword">new</span> SqlParameter(<span class="string">"@Pub"</span>, SqlDbType.NVarChar, <span class="number">100</span>) &#123; Value = <span class="string">"%"</span> + txtAuthor.Text.Trim() + <span class="string">"%"</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//拼接SQL语句</span></span><br><span class="line">    <span class="comment">//如果wheres集合当中的记录条数大于0，证明用户输入了条件</span></span><br><span class="line">    <span class="keyword">if</span> (wheres.Count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sbSql.Append(<span class="string">" where "</span>);<span class="comment">//只要有查询条件就拼接一个where</span></span><br><span class="line">        <span class="comment">//然后把后面的查询条件拼接起来。</span></span><br><span class="line">        sbSql.Append(<span class="keyword">string</span>.Join(<span class="string">" and "</span>, wheres));</span><br><span class="line">    &#125;</span><br><span class="line">    SqlParameter[] pms = listParameters.ToArray();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//SqlHelper.ExecuteReader(sbSql.ToString(), pms);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h2><p><strong>视图</strong>是一张<strong>虚拟表</strong>，它表示一张表的部分数据或多张表的综合数据，其结构和数据是建立在对表的查询基础上。</p>
<p>视图和数据表存在本质的不同：数据表是实际存储记录的地方，然而视图并不保存任何记录。</p>
<p>视图的目的是方便查询，所以一般情况下不能对视图进行增删改。</p>
<h3 id="创建视图"><a href="#创建视图" class="headerlink" title="创建视图"></a>创建视图</h3><p>语法：create View 视图名 as 查询语句。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create view vw_TblArea</span><br><span class="line">as</span><br><span class="line">select</span><br><span class="line">    t1.AreaId 城市编号</span><br><span class="line">    t2.AreaName 城市名称</span><br><span class="line">    t3.AreaName 省份名称 --如果视图中的查询语句中包含了重名的列，此时必须为重名的列起别名</span><br><span class="line">from TblArea as t1</span><br><span class="line">inner join TblArea as t2 on t1.AreaId=t2.AreaPid</span><br><span class="line"></span><br><span class="line">--查询视图</span><br><span class="line">select * from vw_TblArea</span><br></pre></td></tr></table></figure>
<p>视图的优点：</p>
<ul>
<li>筛选表中的行，降低数据库的复杂程度。</li>
<li>防止未经许可的用户访问敏感数据。</li>
</ul>
<p><strong>注意</strong>：</p>
<ol>
<li>视图中的查询不能使用order by，除非指定了top语句。（视图被认为是一个虚拟表，表是一个集合，是不能有顺序的。而order by则返回的是一个有顺序的，是一个游标）</li>
<li>所有查询的列，必须有列名，且列名必须唯一。</li>
<li>create view vw_name as 后面不能跟begin end。</li>
</ol>
<h2 id="T-SQL编程"><a href="#T-SQL编程" class="headerlink" title="T-SQL编程"></a>T-SQL编程</h2><h3 id="声明变量"><a href="#声明变量" class="headerlink" title="声明变量"></a>声明变量</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @name nvarchar(50)</span><br><span class="line">declare @age int</span><br><span class="line"></span><br><span class="line">--声明多个变量</span><br><span class="line">declare @address nvarchar(500),@id int --一句话声明两个变量</span><br></pre></td></tr></table></figure>
<h3 id="为变量赋值"><a href="#为变量赋值" class="headerlink" title="为变量赋值"></a>为变量赋值</h3><h4 id="简单赋值"><a href="#简单赋值" class="headerlink" title="简单赋值"></a>简单赋值</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set @name=&apos;abc&apos;</span><br><span class="line">select @age=18</span><br></pre></td></tr></table></figure>
<h4 id="在查询中给变量赋值"><a href="#在查询中给变量赋值" class="headerlink" title="在查询中给变量赋值"></a>在查询中给变量赋值</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @a int</span><br><span class="line">set @a = (select count(*) from TblStudent) --查询语句结果赋值给变量，必须加括号</span><br><span class="line">select @a = count(*) from TblStudent</span><br><span class="line">print @a</span><br></pre></td></tr></table></figure>
<p><strong>当通过set为变量赋值的时候，如果查询语句返回的不止一个值，则报错。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @a int</span><br><span class="line">set @a = (select tsage from TblStudent) --tsage返回多个值，报错</span><br></pre></td></tr></table></figure>
<p><strong>当通过select为变量赋值的时候，如果查询语句返回的不止一个值，那么会将最后一个结果赋值给该变量。</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @a int</span><br><span class="line">select @a = tsage from TblStudent --@a的值为select查询结果的最后一个值</span><br></pre></td></tr></table></figure>
<h3 id="输出"><a href="#输出" class="headerlink" title="输出"></a>输出</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select &apos;姓名&apos;,@name</span><br><span class="line">select &apos;年龄&apos;,@age</span><br></pre></td></tr></table></figure>
<h3 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @i int=1 --声明变量的同时赋值</span><br><span class="line">while @i&lt;=100</span><br><span class="line">begin</span><br><span class="line">    print &apos;hello&apos;</span><br><span class="line">    set @i=@i+1</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>退出本次循环：continue</li>
<li>退出循环：break</li>
<li>BEGIN和END相当于C#中的{}</li>
</ul>
<h3 id="计算1到100的和"><a href="#计算1到100的和" class="headerlink" title="计算1到100的和"></a>计算1到100的和</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @i int=1</span><br><span class="line">declare @sum int=0 --必须赋初值</span><br><span class="line">while @i&lt;=100</span><br><span class="line">begin</span><br><span class="line">    set @sum=@sum+@i</span><br><span class="line">    set @i=@i+1</span><br><span class="line">end</span><br><span class="line">select @sum</span><br></pre></td></tr></table></figure>
<h3 id="if…else…"><a href="#if…else…" class="headerlink" title="if…else…"></a>if…else…</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @n int=10</span><br><span class="line"></span><br><span class="line">if @n&gt;10</span><br><span class="line">begin</span><br><span class="line">    print &apos;@n大于10&apos;</span><br><span class="line">end</span><br><span class="line">else if @n&gt;5</span><br><span class="line">begin</span><br><span class="line">    print &apos;@n大于5&apos;</span><br><span class="line">end</span><br><span class="line">else</span><br><span class="line">begin</span><br><span class="line">    print &apos;@n小于等于5&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="计算1-100之间所有奇数的和"><a href="#计算1-100之间所有奇数的和" class="headerlink" title="计算1-100之间所有奇数的和"></a>计算1-100之间所有奇数的和</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">declare @sum int=0, @i int=1</span><br><span class="line"></span><br><span class="line">while @i&lt;=100</span><br><span class="line">begin</span><br><span class="line">    if @i%2&lt;&gt;0</span><br><span class="line">    begin</span><br><span class="line">        set @sum=@sum+@i</span><br><span class="line">    end</span><br><span class="line">    set @i=@i+1</span><br><span class="line">end</span><br><span class="line">print @sum --2500</span><br></pre></td></tr></table></figure>
<h3 id="系统变量"><a href="#系统变量" class="headerlink" title="系统变量"></a>系统变量</h3><p>两个@@符号开头的一般都是系统变量。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print @@version</span><br></pre></td></tr></table></figure>
<p><strong>@@error</strong>，表示最后一个T-SQL错误的错误号。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">set @@version = &apos;jk sql serevr 1998&apos; --错误102，系统变量不能赋值</span><br><span class="line">print @@error --102</span><br></pre></td></tr></table></figure>
<p><strong>@@language</strong>，表示当前使用的语言名称。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print @@language --简体中文</span><br></pre></td></tr></table></figure>
<p><strong>@@max_connections</strong>，表示可以创建的同时连接的最大数目。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print @@max_connections --32767</span><br></pre></td></tr></table></figure>
<p><strong>@@rowcount</strong>，表示受上一个SQL语句影响的行数。C#中ExecuteNonQuery返回的是<strong>增删改影响的行数</strong>，而T-SQL中可以用系统变量@@rowcount，获取上一次SQL语句影响的行数（增删改查）。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select * from TblClass --21行受影响</span><br><span class="line">print @@rowcount --21</span><br></pre></td></tr></table></figure>
<p><strong>@@servername</strong>，表示本地服务器的名称。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">print @@servername --QH-20140622LMWU</span><br></pre></td></tr></table></figure>
<h2 id="事务（transaction）"><a href="#事务（transaction）" class="headerlink" title="事务（transaction）"></a>事务（transaction）</h2><h3 id="什么是事务"><a href="#什么是事务" class="headerlink" title="什么是事务"></a>什么是事务</h3><p>事务是指，访问并可能更新数据库中各种数据项的一个程序执行单元。也就是<strong>由多个SQL语句组成，必须作为一个整体执行</strong>。这些SQL语句作为一个整体一起向系统提交，<strong>要么都执行，要么都不执行。</strong></p>
<p><strong>语法步骤</strong></p>
<ul>
<li>开始事务：BEGIN <strong>TRAN</strong>SACTION（可以省略后面的SACTION）</li>
<li>事务提交：COMMIT TRANSACTION</li>
<li>回滚事务：ROLLBACK TRANSACTION</li>
</ul>
<p>如何保证两条SQL语句同时执行成功或者同时执行失败呢？<strong>使用事务来保证</strong>。假设以银行账户转账为例：一个账户给另一个账户转账100。则必须保证一个账户的余额扣除100并且另一个账户的余额增加100，才能转账成功。（两条SQL语句同时执行成功或执行失败）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">update bank set balance = balance - 100 where cid = &apos;0002&apos;</span><br><span class="line">update bank set balance = balance + 100 where cid = &apos;0001&apos;</span><br></pre></td></tr></table></figure>
<h3 id="通过事务执行转账"><a href="#通过事务执行转账" class="headerlink" title="通过事务执行转账"></a>通过事务执行转账</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--1.打开一个事务</span><br><span class="line">begin transaction</span><br><span class="line">declare @sum int = 0</span><br><span class="line">    --在转账之前，最好通过if-else判断，不要让程序发生异常或者错误。</span><br><span class="line">    --第一条SQL语句</span><br><span class="line">    update bank set balance = balance - 100 where cid = &apos;0002&apos;</span><br><span class="line">    set @sum = @sum + @@error</span><br><span class="line"></span><br><span class="line">    --第二条SQL语句</span><br><span class="line">    update bank set balance = balance + 100 where cid = &apos;0001&apos;</span><br><span class="line">    set @sum = @sum + @@error</span><br><span class="line"></span><br><span class="line">    --只要有任何一条SQL语句执行出错，那么最后的@sum就不是0</span><br><span class="line">    if @sum &lt;&gt; 0</span><br><span class="line">    begin</span><br><span class="line">        --表示程序执行出错</span><br><span class="line">        --回滚</span><br><span class="line">        rollback</span><br><span class="line">    end</span><br><span class="line">    else</span><br><span class="line">    begin</span><br><span class="line">        --如果没有出错，则提交事务</span><br><span class="line">        commit</span><br><span class="line">    end</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：</p>
<ul>
<li>事务使用<strong>begin</strong>来开始事务。事务开始后没有end，只有两种结果，就是<strong>commit</strong>和<strong>rollback</strong>。</li>
<li>判断某条语句执行是否出错。使用系统变量<strong>@error</strong>。由于@error只能判断当前一条T-SQL语句执行是否有错，为了判断事务中所有T-SQL语句是否有错，需要对错误进行累计。如SET @sum = @sum + @@error</li>
<li>即使使用事务，也尽量不要让程序发生异常或者报错（使用if-else避免）。</li>
</ul>
<h3 id="SQL-Server中事务的分类"><a href="#SQL-Server中事务的分类" class="headerlink" title="SQL Server中事务的分类"></a>SQL Server中事务的分类</h3><h4 id="自动提交事务"><a href="#自动提交事务" class="headerlink" title="自动提交事务"></a>自动提交事务</h4><p>当执行一条SQL语句时，数据库自动帮我们打开一个事务。<strong>当语句执行成功，数据库自动提交事务；执行失败，数据库自动回滚事务</strong>。如最普通的insert语句。<strong>默认情况下，SQL Server使用自动提交事务</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">insert into bbbb values(aaa)</span><br></pre></td></tr></table></figure>
<h4 id="隐式事务"><a href="#隐式事务" class="headerlink" title="隐式事务"></a>隐式事务</h4><p>每次执行一条SQL语句的时候，数据库自动帮我们打开一个事务，但是<strong>需要我们手动提交事务，或者回滚事务</strong>。</p>
<p>打开或关闭隐式事务：SET IMPLICIT_TRANSACTIONS { ON | OFF }</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--打开隐式事务</span><br><span class="line">set implicit_transactions on</span><br><span class="line">insert into bank values(&apos;0003&apos;, 1000000)</span><br><span class="line">commit --需要手动提交事务，否则查询该表会一直等待</span><br><span class="line">set implicit_transactions off --关闭隐式事务</span><br></pre></td></tr></table></figure>
<h4 id="显式事务"><a href="#显式事务" class="headerlink" title="显式事务"></a>显式事务</h4><p><strong>需要手动打开事务，手动提交事务或者回滚事务</strong>。即用begin tran代码。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">begin tran</span><br><span class="line">--代码</span><br><span class="line">commit tran</span><br><span class="line">--代码</span><br><span class="line">--rollback transaction</span><br></pre></td></tr></table></figure>
<h3 id="事务的特性"><a href="#事务的特性" class="headerlink" title="事务的特性"></a>事务的特性</h3><p>事务的四个属性，也称为事务的ACID属性。</p>
<p><strong>原子性（Actomicity）</strong>：事务是一个完整的操作，事务的各步操作是不可分的（原子的）。即，要么执行，要么不执行。</p>
<p><strong>一致性（Consistency）</strong>：当数据完成时，数据必须处于一致状态。</p>
<p><strong>隔离性（Isolation）</strong>：对数据进行修改的所有并发事务是彼此隔离的，这表明事务必须是独立的，它不应以任何方式依赖于或影响其他事务。</p>
<p><strong>永久性（Durability）</strong>：事务完成后，它对数据库的修改被永久保持，事务日志能够保持事务的永久性。</p>
<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><p><strong>存储过程Procedure</strong>是一组为了完成特定功能而<strong>封装好的的SQL语句集合</strong>，就像数据库中运行的方法（函数），经编译后存储在数据库中，用户通过指定存储过程的名称并给出参数来执行。</p>
<p><strong>存储过程的优点</strong></p>
<ul>
<li>执行速度快 —— 在数据库中保存的存储过程语句都是编译过的。</li>
<li>允许模块化程序设计 —— 类似方法的复用。</li>
<li>提高系统安全性 —— 防止SQL注入。</li>
<li>减少网络流通量 —— 只要传输存储过程的名称。（如果使用ADO.NET，则要传输很长的SQL语句给数据库服务器）</li>
</ul>
<h3 id="系统存储过程"><a href="#系统存储过程" class="headerlink" title="系统存储过程"></a>系统存储过程</h3><p>系统存储过程由数据库定义，存放在master数据库中。<strong>系统存储过程名称一般以“sp_”开头或“xp_”开头</strong>。自定义的存储过程可以以“usp_”开头。常用的存储过程如下。</p>
<table>
<thead>
<tr>
<th>系统存储过程</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>sp_databases</td>
<td>列出服务器上的所有数据库。</td>
</tr>
<tr>
<td>sp_helpdb</td>
<td>报告有关指定数据库或所有数据库的信息。</td>
</tr>
<tr>
<td>sp_renamedb</td>
<td>更改数据库的名称。</td>
</tr>
<tr>
<td>sp_tables</td>
<td>返回当前环境下可查询的对象的列表。</td>
</tr>
<tr>
<td>sp_columns</td>
<td>返回某个表列的信息。</td>
</tr>
<tr>
<td>sp_help</td>
<td>查看某个表的所有信息。</td>
</tr>
<tr>
<td>sp_helpconstraint</td>
<td>查看某个表的约束。</td>
</tr>
<tr>
<td>sp_helpindex</td>
<td>查看某个表的索引。</td>
</tr>
<tr>
<td>sp_stored_procedures</td>
<td>列出当前环境中的所有存储过程。</td>
</tr>
<tr>
<td>sp_password</td>
<td>添加或修改登录账户的密码。</td>
</tr>
<tr>
<td>sp_helptext</td>
<td>显示默认值、未加密的存储过程、用户定义的<br>存储过程、触发器或视图的实际文本。</td>
</tr>
</tbody>
</table>
<h3 id="调用存储过程"><a href="#调用存储过程" class="headerlink" title="调用存储过程"></a>调用存储过程</h3><p>执行存储过程。语法：<strong>exec 存储过程名称 参数</strong>。</p>
<p><strong>一般来说，系统存储过程可以省略exec，自定义的存储过程不能省略exec</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--返回当前实例中的所有的数据库的基本信息</span><br><span class="line">exec sp_databases</span><br><span class="line">--返回当前数据库下的所有的表</span><br><span class="line">exec sp_tables</span><br><span class="line">--返回某张表下的所有的列</span><br><span class="line">exec sp_columns &apos;tblPerson&apos;</span><br><span class="line">--查看某个存储过程的源代码</span><br><span class="line">exec sp_helptext &apos;sp_databases&apos;</span><br></pre></td></tr></table></figure>
<h3 id="创建存储过程"><a href="#创建存储过程" class="headerlink" title="创建存储过程"></a>创建存储过程</h3><p>创建存储过程。语法：<strong>create procedure 存储过程名称 as begin 存储过程内容 end</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--创建自己的存储过程</span><br><span class="line">create procedure usp_helloworld</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    print &apos;hello world!&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="修改存储过程"><a href="#修改存储过程" class="headerlink" title="修改存储过程"></a>修改存储过程</h3><p>一般来说有两种方法修改存储过程。一种是先使用drop删除存储过程，再用create创建存储过程。另一种是直接使用alter修改存储过程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--先删除存储过程，再创建存储过程</span><br><span class="line">drop proc usp_select_tblStudent</span><br><span class="line">create proc usp_select_tblStudent</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select * from TblStudent where tsgender = &apos;男&apos;</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--直接使用alter修改存储过程</span><br><span class="line">alter proc usp_select_tblStudent</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select * from TblStudent where tsgender = &apos;女&apos;</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="创建带参数的存储过程"><a href="#创建带参数的存储过程" class="headerlink" title="创建带参数的存储过程"></a>创建带参数的存储过程</h3><p>创建一个带两个参数的存储过程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--创建一个带两个参数的存储过程</span><br><span class="line">create proc usp_add_number</span><br><span class="line">@n1 int,</span><br><span class="line">@n2 int</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select @n1 + @n2</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--执行存储过程</span><br><span class="line">exec usp_add_number 100,500 --600</span><br></pre></td></tr></table></figure>
<p>根据参数条件查询表中的数据。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create proc usp_select_tblStudent_by_condition</span><br><span class="line">@gender char(2),</span><br><span class="line">@age int</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select * from tblStudent where tsgender = @gender and tsage &gt;= @age</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--执行存储过程</span><br><span class="line">exec usp_select_tblStudent_by_condition @gender = &apos;男&apos;, @age = 20 --指定参数名称</span><br></pre></td></tr></table></figure>
<p>设置存储过程的参数的默认值。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">alter proc usp_add_number</span><br><span class="line">@n1 int = 100, --n1的默认值是100</span><br><span class="line">@n2 int</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select @n1 + @n2</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--执行存储过程</span><br><span class="line">--exec usp_add_number 80 --错误，80默认传给n1，若要传给n2，必须指定参数名称</span><br><span class="line">exec usp_add_number @n2 = 80 --结果是180，这里必须指定参数名称</span><br></pre></td></tr></table></figure>
<p>带输出参数的存储过程。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create proc usp_show_students</span><br><span class="line">@gender char(2),</span><br><span class="line">@recordcount int output --输出参数</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select * from MyStudent where fgender = @gender</span><br><span class="line">    --把查询语句查询到的记录的条数赋值给变量@recordcount</span><br><span class="line">    set @recordcount = (select count(*) from MyStudent where fgender = @gender)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--执行存储过程</span><br><span class="line">declare @rc int</span><br><span class="line">exec usp_show_students @gender = &apos;男&apos;, @recordcount = @rc output</span><br><span class="line"></span><br><span class="line">print @rc --输出记录条数</span><br></pre></td></tr></table></figure>
<h3 id="使用存储过程编写分页查询"><a href="#使用存储过程编写分页查询" class="headerlink" title="使用存储过程编写分页查询"></a>使用存储过程编写分页查询</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create proc usp_getMyStudentsDataByPage</span><br><span class="line">@pagesize int = 7, --每页记录条数</span><br><span class="line">@pageindex int = 1, --当前要查看第几页的记录</span><br><span class="line">@recordcount int output, --总的记录的条数</span><br><span class="line">@pagecount int output --总的页数</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --1.编写查询语句，把用户要的数据查询出来</span><br><span class="line">    select</span><br><span class="line">        t.fid,</span><br><span class="line">        t.fname,</span><br><span class="line">        t.fage,</span><br><span class="line">        t.fgender,</span><br><span class="line">        t.fmath,</span><br><span class="line">        t.fclassid,</span><br><span class="line">        t.fbirthday</span><br><span class="line">    from (select *, rn = row_number() over(order by fid asc) from MyStudent) as t</span><br><span class="line">    where t.rn between (@pageindex - 1) * @pagesize + 1 and @pagesize * @pageindex</span><br><span class="line"></span><br><span class="line">    --2.计算总的记录条数</span><br><span class="line">    set @recordcount = (select count(*) from MyStudent)</span><br><span class="line"></span><br><span class="line">    --3.计算总页数</span><br><span class="line">    set @pagecount = ceiling(@recordcount * 1.0 / @pagesize)</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="通过ADO-NET调用存储过程"><a href="#通过ADO-NET调用存储过程" class="headerlink" title="通过ADO.NET调用存储过程"></a>通过ADO.NET调用存储过程</h3><p><strong>通过ADO.NET调用存储过程与调用带参数的SQL语句的区别</strong>：</p>
<ol>
<li>把SQL语句变成存储过程的名称。</li>
<li>设置SqlCommand对象的CommandType为CommandType.StoredProcedure。</li>
<li>根据存储过程的参数来设置SqlCommand对象的参数。</li>
<li>如果有输出参数需要设置输出参数的Direction属性为：Direction=ParameterDirection.Output。</li>
</ol>
<h4 id="使用SqlDataReader执行存储过程"><a href="#使用SqlDataReader执行存储过程" class="headerlink" title="使用SqlDataReader执行存储过程"></a>使用SqlDataReader执行存储过程</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> pageIndex = <span class="number">1</span>;<span class="comment">//当前要查看的页码</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> pageSize = <span class="number">7</span>;<span class="comment">//每页显示的记录条数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> pageCount;<span class="comment">//总页数</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> recordCount;<span class="comment">//总条数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//窗体加载的时候显示第一页的数据</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Form1_Load</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LoadData();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//根据pageIndex来加载数据</span></span><br><span class="line">    <span class="keyword">string</span> constr = <span class="string">"Data Source=.;Initial Catalog=Lottery;Integrated Security=True"</span>;</span><br><span class="line">    <span class="keyword">using</span> (SqlConnection conn = <span class="keyword">new</span> SqlConnection(constr))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//将SQL语句变成存储过程名称</span></span><br><span class="line">        <span class="keyword">string</span> sql = <span class="string">"usp_getUserInfoByPage"</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">using</span> (SqlCommand cmd = <span class="keyword">new</span> SqlCommand(sql, conn))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//告诉SqlCommand对象，现在执行的存储过程不是SQL语句</span></span><br><span class="line">            cmd.CommandType = CommandType.StoredProcedure;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//增加参数（存储过程中有几个参数，这里就需要增加几个参数）</span></span><br><span class="line">            SqlParameter[] pms = <span class="keyword">new</span> SqlParameter[] &#123;</span><br><span class="line">                <span class="keyword">new</span> SqlParameter(<span class="string">"@pagesize"</span>, SqlDbType.Int) &#123; Value = pageSize &#125;,</span><br><span class="line">                <span class="keyword">new</span> SqlParameter(<span class="string">"@pageindex"</span>, SqlDbType.Int) &#123; Value = pageIndex &#125;,</span><br><span class="line">                <span class="keyword">new</span> SqlParameter(<span class="string">"@recordcount"</span>, SqlDbType.Int) &#123; Direction = ParameterDirection.Output &#125;,</span><br><span class="line">                <span class="keyword">new</span> SqlParameter(<span class="string">"@pagecount"</span>, SqlDbType.Int) &#123; Direction = ParameterDirection.Output &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            cmd.Parameters.AddRange(pms);</span><br><span class="line">            <span class="comment">//打开连接</span></span><br><span class="line">            conn.Open();</span><br><span class="line">            <span class="comment">//执行</span></span><br><span class="line">            <span class="keyword">using</span> (SqlDataReader reader = cmd.ExecuteReader())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (reader.HasRows)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">while</span> (reader.Read())</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; reader.FieldCount; i++)</span><br><span class="line">                        &#123;</span><br><span class="line">                            Console.WriteLine(reader[i] + <span class="string">"   |   "</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        Console.WriteLine();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">"没有数据"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//不能在此获取输出参数</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//获取输出参数</span></span><br><span class="line">            recordCount = pms[<span class="number">2</span>].Value.ToString();</span><br><span class="line">            pageCount = pms[<span class="number">3</span>].Value.ToString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：如果是通过Command对象的<strong>ExecuteReader方法</strong>来执行的存储过程，那么要想获取输出参数，<strong>必须得等到关闭reader对象后，才能获取输出参数</strong>。</p>
<h4 id="使用SqlDataAdapter执行存储过程"><a href="#使用SqlDataAdapter执行存储过程" class="headerlink" title="使用SqlDataAdapter执行存储过程"></a>使用SqlDataAdapter执行存储过程</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LoadData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//根据pageIndex来加载数据</span></span><br><span class="line">    <span class="keyword">string</span> constr = <span class="string">"Data Source=.;Initial Catalog=Lottery;Integrated Security=True"</span>;</span><br><span class="line">    DataTable dt = <span class="keyword">new</span> DataTable();</span><br><span class="line">    <span class="keyword">using</span> (SqlDataAdapter adapter = <span class="keyword">new</span> SqlDataAdapter(<span class="string">"usp_getUserInfoByPage"</span>, constr))</span><br><span class="line">    &#123;</span><br><span class="line">        adapter.SelectCommand.CommandType = CommandType.StoredProcedure;</span><br><span class="line">        <span class="comment">//增加参数（存储过程中有几个参数，这里就需要增加几个参数）</span></span><br><span class="line">        SqlParameter[] pms = <span class="keyword">new</span> SqlParameter[] &#123;</span><br><span class="line">            <span class="keyword">new</span> SqlParameter(<span class="string">"@pagesize"</span>, SqlDbType.Int) &#123; Value = pageSize &#125;,</span><br><span class="line">            <span class="keyword">new</span> SqlParameter(<span class="string">"@pageindex"</span>, SqlDbType.Int) &#123; Value = pageIndex &#125;,</span><br><span class="line">            <span class="keyword">new</span> SqlParameter(<span class="string">"@recordcount"</span>, SqlDbType.Int) &#123; Direction = ParameterDirection.Output &#125;,</span><br><span class="line">            <span class="keyword">new</span> SqlParameter(<span class="string">"@pagecount"</span>, SqlDbType.Int) &#123; Direction = ParameterDirection.Output &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        adapter.SelectCommand.Parameters.AddRange(pms);</span><br><span class="line">        adapter.Fill(dt);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取输出参数并且赋值给label</span></span><br><span class="line">        label1.Text = pms[<span class="number">2</span>].Value.ToString();</span><br><span class="line">        label2.Text = pms[<span class="number">3</span>].Value.ToString();</span><br><span class="line">        <span class="comment">//数据绑定</span></span><br><span class="line">        <span class="keyword">this</span>.dataGridView1.DataSource = dt;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：ADO.NET执行存储过程时，需要设置CommandType.StoredProcedure。<strong>设置完毕该属性后，相当于在存储过程的名字前面增加exec。如果没有设置该属性，则必须在存储过程名字前加exec</strong>，如“exec usp_getUserInfoByPage”。</p>
<h3 id="调用存储过程实现转账"><a href="#调用存储过程实现转账" class="headerlink" title="调用存储过程实现转账"></a>调用存储过程实现转账</h3><h4 id="把事务转账封装成存储过程"><a href="#把事务转账封装成存储过程" class="headerlink" title="把事务转账封装成存储过程"></a>把事务转账封装成存储过程</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--创建存储过程实现转账</span><br><span class="line">create proc usp_transfer_bank</span><br><span class="line">@from char(4),</span><br><span class="line">@to char(4),</span><br><span class="line">@balance money,	--转账金额</span><br><span class="line">@resultNumber int output	--转账是否成功（1表示成功，2表示失败，3表示余额不足）</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --1.判断金额是否足够转账</span><br><span class="line">    declare @money money</span><br><span class="line">    select @money = balance from bank where cid = @from</span><br><span class="line">    if @money - @balance &gt;= 10</span><br><span class="line">    begin</span><br><span class="line">        --开始转账</span><br><span class="line">        begin transaction</span><br><span class="line">            declare @sum int = 0</span><br><span class="line">            --2.账户1扣钱</span><br><span class="line">            update bank set balance = balance - @balance where cid = @from</span><br><span class="line">            set @sum = @sum + @@error</span><br><span class="line">            --3.账户2加钱</span><br><span class="line">            update bank set balance = balance + @balance where cid = @to</span><br><span class="line">            set @sum = @sum + @@error</span><br><span class="line">            --4.判断执行是否成功，进行提交或者回滚</span><br><span class="line">            if @sum &lt;&gt; 0</span><br><span class="line">            begin</span><br><span class="line">                set @resultNumber = 2	--转账失败</span><br><span class="line">                rollback</span><br><span class="line">            end</span><br><span class="line">            else</span><br><span class="line">            begin</span><br><span class="line">                set @resultNumber = 1	--转账成功</span><br><span class="line">                commit</span><br><span class="line">            end</span><br><span class="line">    end</span><br><span class="line">    else</span><br><span class="line">    begin</span><br><span class="line">        set @resultNumber = 3	--余额不足</span><br><span class="line">    end</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h4 id="测试存储过程是否转账成功"><a href="#测试存储过程是否转账成功" class="headerlink" title="测试存储过程是否转账成功"></a>测试存储过程是否转账成功</h4><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--@from char(4),</span><br><span class="line">--@to char(4),</span><br><span class="line">--@balance money,	--转账金额</span><br><span class="line">--@resultNumber bit output</span><br><span class="line">declare @r int</span><br><span class="line">exec usp_transfer_bank @from = &apos;0001&apos;, @to = &apos;0002&apos;, @balance = 900, @resultNumber = @r output</span><br><span class="line">print @r</span><br></pre></td></tr></table></figure>
<h4 id="ADO-NET调用转账存储过程转账"><a href="#ADO-NET调用转账存储过程转账" class="headerlink" title="ADO.NET调用转账存储过程转账"></a>ADO.NET调用转账存储过程转账</h4><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">button1_click</span>(<span class="params"><span class="keyword">object</span> sender, EventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">string</span> <span class="keyword">from</span>  = textBox1.Text.Trim();</span><br><span class="line">    <span class="keyword">string</span> to = textBox2.Text.Trim();</span><br><span class="line">    <span class="keyword">double</span> money = <span class="keyword">double</span>.Parse(textBox3.Text.Trim());</span><br><span class="line">    </span><br><span class="line">    SqlParameter[] pms = <span class="keyword">new</span> SqlParameter[] &#123;</span><br><span class="line">        <span class="keyword">new</span> SqlParameter(<span class="string">"@from"</span>, SqlDbType.Char, <span class="number">4</span>) &#123; Value = <span class="keyword">from</span> &#125;,</span><br><span class="line">        <span class="keyword">new</span> SqlParameter(<span class="string">"@to"</span>, SqlDbType.Char, <span class="number">4</span>) &#123; Value = to &#125;,</span><br><span class="line">        <span class="keyword">new</span> SqlParameter(<span class="string">"@balance"</span>, SqlDbType.Money) &#123; Value = money &#125;,</span><br><span class="line">        <span class="keyword">new</span> SqlParameter(<span class="string">"@resultNumber"</span>, SqlDbType.Int) &#123; Direction = ParameterDirection.Output &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过SqlHelper调用存储过程实现转账</span></span><br><span class="line">    SqlHelper.ExecuteNonQuery(<span class="string">"usp_transfer_bank"</span>, CommandType.StoreProcedure, pms);</span><br><span class="line">    <span class="comment">//获取输出参数</span></span><br><span class="line">    <span class="keyword">int</span> result = Convert.ToInt32(pms[<span class="number">3</span>].Value);</span><br><span class="line">    <span class="keyword">if</span> (result == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(<span class="string">"成功！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="number">2</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(<span class="string">"失败！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        MessageBox.Show(<span class="string">"余额不足！"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>注意</strong>：ADO.NET调用存储过程时，<strong>ExecuteReader、ExecuteNonQuery、ExecuteScalar</strong>，<strong>无论是调用哪个方法都可以执行成功</strong>。要调用哪个方法，主要取决于<strong>执行完存储过程后希望获取到的结果</strong>。</p>
<h3 id="通过存储过程对表实现增删改查"><a href="#通过存储过程对表实现增删改查" class="headerlink" title="通过存储过程对表实现增删改查"></a>通过存储过程对表实现增删改查</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">--1.向TblClass表中插入数据</span><br><span class="line">create proc usp_insert_TblClass</span><br><span class="line">@name varchar(50),</span><br><span class="line">@desc varchar(50)</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    insert into TblClass values(@name, @desc)</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--2.删除TblClass表中的记录（根据主键ID）</span><br><span class="line">create proc usp_delete_TblClass</span><br><span class="line">@tsclassid int</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    delete from TblClass where tsClassId = @tsclassid</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--3.更新TblClass表</span><br><span class="line">create proc usp_update_TblClass</span><br><span class="line">@tsclassid int</span><br><span class="line">@name varchar(50),</span><br><span class="line">@desc varchar(50),</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    update TblClass set tClassName = @name, tClassDesc = @desc where tsClassId = @tsclassid</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">--4.查询</span><br><span class="line">create proc usp_selectAll_TblClass</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    select * from TblClass</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<h3 id="T-SQL中的try…catch语句"><a href="#T-SQL中的try…catch语句" class="headerlink" title="T-SQL中的try…catch语句"></a>T-SQL中的try…catch语句</h3><p>语法：<strong>begin try … end try begin catch … end catch</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">begin try</span><br><span class="line">    update bank set balance = -100</span><br><span class="line">end try</span><br><span class="line">begin catch</span><br><span class="line">    print &apos;出异常了&apos;</span><br><span class="line">end catch</span><br></pre></td></tr></table></figure>
<h3 id="问题：同一个SqlParameter参数不能同时用于多个Command对象"><a href="#问题：同一个SqlParameter参数不能同时用于多个Command对象" class="headerlink" title="问题：同一个SqlParameter参数不能同时用于多个Command对象"></a>问题：同一个SqlParameter参数不能同时用于多个Command对象</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    SqlParameter[] pms = <span class="keyword">new</span> SqlParameter[] &#123;</span><br><span class="line">        <span class="keyword">new</span> SqlParameter(<span class="string">"@name"</span>, System.Data.SqlDbType.Varchar, <span class="number">50</span>),</span><br><span class="line">        <span class="keyword">new</span> SqlParameter(<span class="string">"@desc"</span>, System.Data.SqlDbType.Varchar, <span class="number">50</span>)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第一次执行SQL语句</span></span><br><span class="line">    <span class="keyword">string</span> sql = <span class="string">"insert into TblClass values(@name, @desc)"</span>;</span><br><span class="line">    pms[<span class="number">0</span>].Value = <span class="string">"aaa"</span>;</span><br><span class="line">    pms[<span class="number">1</span>].Value = <span class="string">"aaa"</span>;</span><br><span class="line">    SqlHelper.ExecuteNonQuery(sql, System.Data.CommandType.Text, pms);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二次执行SQL语句</span></span><br><span class="line">    <span class="keyword">string</span> sqlTwo = <span class="string">"insert into TblClass values(@name, @desc)"</span>;</span><br><span class="line">    pms[<span class="number">0</span>].Value = <span class="string">"bbb"</span>;</span><br><span class="line">    pms[<span class="number">1</span>].Value = <span class="string">"bbb"</span>;</span><br><span class="line">    SqlHelper.ExecuteNonQuery(sqlTwo, System.Data.CommandType.Text, pms);<span class="comment">//报错：另一个SqlParameterCollection中已经包含SqlParameter。</span></span><br><span class="line">    <span class="comment">//因为pms在别的Command对象中已经使用过了</span></span><br><span class="line">    </span><br><span class="line">    Console.WriteLine(<span class="string">"ok"</span>);</span><br><span class="line">    Console.ReadKey();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="触发器Trigger"><a href="#触发器Trigger" class="headerlink" title="触发器Trigger"></a>触发器Trigger</h2><p>触发器是一种特<strong>殊的存储过程</strong>（不能传参数），它通过<strong>事件进行触发而被执行</strong>。</p>
<p>触发器的作用：<strong>自动化操作</strong>，减少手动操作以及出错的概率。</p>
<p><strong>DML触发器</strong></p>
<p>对表中的数据进行操作时触发。</p>
<ul>
<li>insert、delete、update（不支持select）。</li>
<li>after触发器（for）、instead of触发器（不支持before触发器）。</li>
</ul>
<p><strong>DDL触发器</strong></p>
<p>对表的结构定义修改时触发。</p>
<ul>
<li>create table、create database、alter、drop等。</li>
</ul>
<h3 id="inserted表和deleted表"><a href="#inserted表和deleted表" class="headerlink" title="inserted表和deleted表"></a>inserted表和deleted表</h3><p><strong>insert操作</strong>用到了<strong>inserted表</strong>。</p>
<p><strong>delete操作</strong>用到了<strong>deleted表</strong>。</p>
<p><strong>update操作</strong>用到了<strong>inserted表和deleted表</strong>。</p>
<h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><p><strong>after触发器</strong>：在语句执行完毕后触发（after和for都表示after触发器）。</p>
<p><strong>instead of触发器</strong>：要用来替换原本的操作。</p>
<p><strong>语法</strong>：create trigger 触发器名 on 表名 after(for) | instead of update|insert|delete (insert,update,delete) as begin … end</p>
<p>创建一个删除触发器。<strong>删除一个表的数据时，把删除的数据插入到另一个表中</strong>。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">create trigger tri_delete_tblclass on TblClass</span><br><span class="line">after delete</span><br><span class="line">as</span><br><span class="line">begin</span><br><span class="line">    --从deleted表中读取删除的数据</span><br><span class="line">    insert into TblClassBackup(tsClassName, tsClassdesc)</span><br><span class="line">    select tsClassName, tsClassDesc from deleted --deleted表只有在触发器里面才能访问</span><br><span class="line">    --rollback --可以在触发器中使用rollback，使用后数据回滚</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p><strong>触发器建议</strong>：</p>
<ul>
<li>尽量避免在触发器中执行耗时操作。因为触发器会与SQL语句认为在同一个事务中。（事务不结束，就无法释放锁）</li>
<li>避免在触发器中做复杂的操作。</li>
<li>deleted表和inserted表，只能在触发器中访问，不能直接访问。</li>
<li>可以在触发器中使用rollback，使用后数据会进行回滚。</li>
</ul>

                <hr>
                

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2019/07/07/C-图解教程之委托/" data-toggle="tooltip" data-placement="top"
                           title="C#图解教程之委托">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2019/06/03/数据库开发（六）索引、内连接、子查询/" data-toggle="tooltip" data-placement="top"
                           title="数据库开发（六）索引、内连接、子查询">Next Post &rarr;</a>
                    </li>
                    
                </ul>

                

                


                <!--加入新的评论系统-->
                

                

            </div>

            <div class="hidden-xs col-sm-3 toc-col">
                <div class="toc-wrap">
                    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#外连接"><span class="toc-text">外连接</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#左外连接和右外连接"><span class="toc-text">左外连接和右外连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#外连接的原理"><span class="toc-text">外连接的原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自连接"><span class="toc-text">自连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#多条件查询"><span class="toc-text">多条件查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#视图"><span class="toc-text">视图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建视图"><span class="toc-text">创建视图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#T-SQL编程"><span class="toc-text">T-SQL编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#声明变量"><span class="toc-text">声明变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为变量赋值"><span class="toc-text">为变量赋值</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#简单赋值"><span class="toc-text">简单赋值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在查询中给变量赋值"><span class="toc-text">在查询中给变量赋值</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#输出"><span class="toc-text">输出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#while循环"><span class="toc-text">while循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计算1到100的和"><span class="toc-text">计算1到100的和</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if…else…"><span class="toc-text">if…else…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#计算1-100之间所有奇数的和"><span class="toc-text">计算1-100之间所有奇数的和</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统变量"><span class="toc-text">系统变量</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#事务（transaction）"><span class="toc-text">事务（transaction）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是事务"><span class="toc-text">什么是事务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过事务执行转账"><span class="toc-text">通过事务执行转账</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-Server中事务的分类"><span class="toc-text">SQL Server中事务的分类</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自动提交事务"><span class="toc-text">自动提交事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#隐式事务"><span class="toc-text">隐式事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#显式事务"><span class="toc-text">显式事务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#事务的特性"><span class="toc-text">事务的特性</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#存储过程"><span class="toc-text">存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#系统存储过程"><span class="toc-text">系统存储过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用存储过程"><span class="toc-text">调用存储过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建存储过程"><span class="toc-text">创建存储过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改存储过程"><span class="toc-text">修改存储过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建带参数的存储过程"><span class="toc-text">创建带参数的存储过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用存储过程编写分页查询"><span class="toc-text">使用存储过程编写分页查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过ADO-NET调用存储过程"><span class="toc-text">通过ADO.NET调用存储过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用SqlDataReader执行存储过程"><span class="toc-text">使用SqlDataReader执行存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用SqlDataAdapter执行存储过程"><span class="toc-text">使用SqlDataAdapter执行存储过程</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调用存储过程实现转账"><span class="toc-text">调用存储过程实现转账</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#把事务转账封装成存储过程"><span class="toc-text">把事务转账封装成存储过程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试存储过程是否转账成功"><span class="toc-text">测试存储过程是否转账成功</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ADO-NET调用转账存储过程转账"><span class="toc-text">ADO.NET调用转账存储过程转账</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#通过存储过程对表实现增删改查"><span class="toc-text">通过存储过程对表实现增删改查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#T-SQL中的try…catch语句"><span class="toc-text">T-SQL中的try…catch语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#问题：同一个SqlParameter参数不能同时用于多个Command对象"><span class="toc-text">问题：同一个SqlParameter参数不能同时用于多个Command对象</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#触发器Trigger"><span class="toc-text">触发器Trigger</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#inserted表和deleted表"><span class="toc-text">inserted表和deleted表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基本语法"><span class="toc-text">基本语法</span></a></li></ol></li></ol>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5 class="text-center">
                        <a href="/tags/">FEATURED TAGS</a>
                    </h5>
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#SQL Server"
                           title="SQL Server">SQL Server</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <div style="margin-top: 20px;">
                    <h5 class="text-center">FRIENDS</h5>
                    <ul class="list-inline text-center">
                        
                        <li><a href="http://laibh.top">赖同学</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>

    </div>
</article>







<!-- Footer -->
<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 text-center">
                <br>
                <ul class="list-inline text-center">
                
                
                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Zhendong 2021
                    <br>
                    <span id="busuanzi_container_site_uv">本站访客数<span id="busuanzi_value_site_uv"></span>人次</span>
                    <br>
                    Theme by <a href="https://haojen.github.io/">Haojen Ma</a>
                </p>

            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/blog.js"></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://zhdaa.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>

<!-- Google Analytics -->



<!-- Baidu Tongji -->

<script>
    var _baId = '4cc1f2d8f3067386cc5cdb626a202900';
    // Originial
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?" + _baId;
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>


<!-- swiftype -->
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','','2.0.0');
</script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<!--wechat title img-->
<img class="wechat-title-img" src="/images/zhdaa-headimg.jpg">
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"left","width":100,"height":200},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>

</html>
